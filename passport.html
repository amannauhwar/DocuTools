<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passport Image Maker</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
    <a href="index.html" class="nav-link">&larr; Back to Home</a>
    </nav>
    <main>
        <h2>Upload Your File</h2>
        <p>Select a file to upload and download a processed version.</p>

        <label for="file-input" class="file-label">Choose File</label>
        <input type="file" id="file-input" />
        
        <span id="file-name">No file selected</span>
        
        <button id="upload-button">Upload</button>
        <!-- <button id="download-button">Download</button> -->
        
        <p id="status" class="status-info"></p>
    </main>

<script>
        // === CONFIGURATION ===
        const API_SERVER_URL = "https://2n57pjdjyfwn2s7m4zjormgwuy0lirsc.lambda-url.eu-north-1.on.aws"; 
        const POLLING_INTERVAL = 2000;
        const MAX_POLLS = 20; 
        // =====================
        
        // UI References
        // ★ NEW: We grab the main container directly so we don't get "null" parent errors
        const mainContainer = document.querySelector('main');
        
        const fileInput = document.getElementById('file-input');
        const fileLabel = document.querySelector('.file-label');
        const fileNameDisplay = document.getElementById('file-name');
        const statusMessage = document.getElementById('status');
        
        // Keep reference to the ORIGINAL Upload button
        const originalUploadButton = document.getElementById('upload-button');
        
        // Tracker: Which button is currently on the screen?
        let currentButton = originalUploadButton;
        
        let selectedFile = null;

        // --- RESET LOGIC (Runs when user picks a new file) ---
        fileInput.addEventListener('change', () => {
            selectedFile = fileInput.files[0];
            
            // Update Text
            fileNameDisplay.textContent = selectedFile ? selectedFile.name : "No file selected";
            fileLabel.textContent = selectedFile ? "Change File" : "Choose File";

            // If we are showing the Download button, swap back to Upload!
            if (currentButton !== originalUploadButton) {
                
                // Safety Check: Only swap if the old button is actually inside the container
                if (mainContainer.contains(currentButton)) {
                    mainContainer.replaceChild(originalUploadButton, currentButton);
                    currentButton = originalUploadButton; // Update tracker
                    setStatus("", "info");
                }
            }
        });

        // Helper functions
        function setStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-${type}`;
        }
        
        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Polling Function
        async function pollForDownload(fileName) {
            let polls = MAX_POLLS;
            while (polls > 0) {
                try {
                    const response = await fetch(`${API_SERVER_URL}/check-download-url?filename=${fileName}`);
                    if (!response.ok) throw new Error("Polling request failed");
                    const data = await response.json();
                    
                    if (data.status === "ready") return data.download_url;
                    
                    polls--;
                    setStatus(`Getting your image ready...`, "info");
                    await wait(POLLING_INTERVAL);
                } catch (error) {
                    console.error("Polling error:", error);
                    polls--;
                    await wait(POLLING_INTERVAL);
                }
            }
            throw new Error("File processing timed out.");
        }

        // --- UPLOAD LOGIC ---
        originalUploadButton.addEventListener('click', async () => {
            if (!selectedFile) {
                setStatus("Please select a file first.", "error");
                return;
            }

            setStatus("Processing...", "info");

            try {
                // Step 1: Get Upload URL
                const response = await fetch(`${API_SERVER_URL}/generate-upload-url?filename=${selectedFile.name}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to get URL');
                }
                const data = await response.json();

                // Step 2: Upload to S3
                setStatus("Working on it...", "info");
                const uploadResponse = await fetch(data.upload_url, {
                    method: 'PUT',
                    body: selectedFile
                });
                if (!uploadResponse.ok) throw new Error('Upload to S3 failed.');
                
                setStatus("Almost done...", "success");

                // Step 3: Poll
                const downloadUrl = await pollForDownload(selectedFile.name);

                // --- SWAP TO DOWNLOAD BUTTON ---
                setStatus("Ready for Download!", "success");
                
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = selectedFile.name; 

                // Clone button
                const downloadButton = originalUploadButton.cloneNode(true);
                downloadButton.textContent = "Download";
                downloadButton.style.backgroundColor = "#28a745";
                
                // Add Animation Class (Make sure you added the CSS I gave you earlier!)
                downloadButton.classList.add('shake-animation');
                
                // Add click listener
                downloadButton.addEventListener('click', () => {
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });

                // ★ SAFE SWAP: Use mainContainer and currentButton ★
                if (mainContainer.contains(currentButton)) {
                    mainContainer.replaceChild(downloadButton, currentButton);
                    currentButton = downloadButton; // Update tracker
                } else {
                    console.error("Could not find the current button to replace!");
                }

            } catch (error) {
                console.error("Upload process failed:", error);
                setStatus(`Error: ${error.message}`, "error");
            }
        });
    </script>
</body>
</html>